var test = require('tap').test

// simulated ulimit
// this is like graceful-fs, but in reverse
var fs_ = require('fs')
var fs = require('../graceful-fs.js')
var files = fs.readdirSync(__dirname)

// Ok, no more actual file reading!

var fds = 0
var nextFd = 60
var limit = 8
fs_.open = function (path, flags, mode, cb) {
  process.nextTick(function() {
    ++fds
    if (fds >= limit) {
      --fds
      var er = new Error('EMFILE Curses!')
      er.code = 'EMFILE'
      er.path = path
      return cb(er)
   